Clear-Host

#Initialisation de mes variables hors boucle
$emplacementFichierCsv = "C:\Users\admin\Desktop\SystemeExploitation-TP3\nom.csv"
$fichierCsv = Get-Content $emplacementFichierCsv
$groupeName = "Entreprise"
$groupExistantOuNon = Get-LocalGroup | Where-Object Name -eq "Entreprise" | Measure
$fichierEntrepriseExsitant = Get-ChildItem -Path "C:\" | Where-Object Name -eq "Entreprise" | Measure

#Création du fichier entreprise
if ($fichierEntrepriseExsitant -eq 1)
{
    Write-Host "Le dossier Entreprise sur le disque C:\ est existant."
}
else
{
    New-Item -ItemType Directory -Name $groupeName -Path "C:\"
    Write-Host "Le dossier Entreprise a été créer avec succès"
}

#Création du groupe Entreprise
if ($groupExistantOuNon.Count -eq 1)
{
    Write-Host "Le groupe $groupeName existe déjà."
}
else
{
    Write-Host "Le groupe $groupeName est innexistant."
    Write-Host "Création du groupe $groupeName ...."
    New-LocalGroup -Name $groupeName
    Write-Host "Le groupe $groupeName a bien été créé."
}

foreach ($line in $fichierCsv) 
{
    #Initialisation de variable et vérification si existant
    $fullname = $line
    $firstName,$lastname = $fullname.Split(" ")
    $firstletter = $firstName[0]
    $username = ($firstletter+$lastname).ToLower()
    $userExistantOuNon = Get-LocalUser | Where-Object Name -eq $username | Measure
    $fichierUserExistantOuNon = Get-ChildItem -Path "C:\Entreprise\" | Where-Object Name -eq $fullname | Measure
    
    #Création des utilisateurs
    if($userExistantOuNon.Count -eq 1)
    {
        Write-Host "L'utilisateur $username existe déjà passons au prochain ..."
    }
    else
    {
        Write-Host "Création de l'utilisateur: $username qui sera ajouté au groupe $groupeName"
        New-LocalUser -Name $username -FullName $fullname -AccountExpires 2022-04-10 -Description "Ceci est le compte de $fullname." -NoPassword
        Add-LocalGroupMember -Group Entreprise -Member $username
    }

    #Création des Sous-Dossiers + Fichier.txt pour les membres
    if ($fichierUserExistantOuNon -eq 1)
    {
        Write-Host "Le fichier C:\Entreprise\$fullname est déjà existant. Passons au prochain"
    }
    else
    {
        New-Item -ItemType Directory -Name $fullname -Path "C:\Entreprise"
        New-Item -ItemType File -Name "Bienvenue.txt" -Value "Bonjour $fullname, bienvenue dans votre dossier de notre Entreprise" -Path C:\Entreprise\$fullname
        Write-Host "Création du dossier C:\Entreprise\$fullname et du fichier de bienvenue complété avec succes."
    }

}

Write-Host "Fin du programme de création d'utilisateurs et de groupes."